<!DOCTYPE html>
<html>
    <head lang="en">
        <meta charset="UTF-8">
        <title>GPS Requests Charts</title>
    </head>
    <body>
        <div>
            <select id="imei">
                <option value="0">ALL IMEI</option>
            </select>
            <label for="from">From</label>
            <input id="from" type="date"/>
            <label for="to">To</label>
            <input id="to" type="date"/>
            <input type="button" id="button" value="Filter"/>
        </div>

        <canvas id="chart" style="width: 100%;height: 400px;margin-top: 50px"></canvas>

        <script type="text/javascript" src="/chart.js/Chart.min.js"></script>
        <script type="text/javascript" src="/jquery/dist/jquery.min.js"></script>
        <script type="text/javascript">
            $(document).ready(function(){
                var chart = null;

                function setChartData(data){
                    var labels  = [];
                    var bad     = [];
                    var ok      = [];

                    $("#imei").children().remove();
                    $("#imei").append("<option value='0'>All IMEI</option>");
                    for(var i = 0; i < data.length; i++){
                        labels.push(data[i].imei);
                        $("#imei").append("<option value='"+data[i].imei+"'>"+data[i].imei+"</option>");

                        bad.push(data[i].allCount-data[i].okCount);
                        ok.push(data[i].okCount);
                    }

                    return {
                        labels: labels,
                        datasets: [
                            {
                                label: "My First dataset",
                                fillColor: "rgba(229, 70, 0, 0.5)",
                                highlightFill: "rgba(189, 36, 0, 0.5)",
                                data: bad
                            },
                            {
                                label: "My Second dataset",
                                fillColor: "rgba(26, 145, 32, 0.5)",
                                highlightFill: "rgba(4, 97, 8, 0.5)",
                                data: ok
                            }
                        ]
                    };
                }

                function updateChart(data){
                    console.log(data);
                    data = JSON.parse(data);
                    var ctx = document.getElementById("chart").getContext("2d");
                    Chart.defaults.global.scaleLineColor = "rgba(0,0,0,.2)";

                    if(!chart){
                        var d = setChartData(data);
                        chart = new Chart(ctx).Bar(d, {
                            barShowStroke: false
                        });
                    }
                    else {
                        chart.destroy();
                        var d = setChartData(data);
                        chart = new Chart(ctx).Bar(d, {
                            barShowStroke: false
                        });
                    }
                }

                function rest(){
                    $.ajax({
                        method: "POST",
                        url: "/api/charts_data",
                        data: {from: $("#from").val(), to: $("#to").val(), imei: $("#imei").val()}
                    }).done(updateChart);
                }

                $("#button").click(rest);
                rest();
            });
        </script>
    </body>
</html>