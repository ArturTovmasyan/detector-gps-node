<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Google Map</title>
    <link href="/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="/css/html5-reset.css" rel="stylesheet"/>
    <link href="/css/style.css" rel="stylesheet"/>
</head>
<body style="background: url('/images/bgnoise_lg.png') repeat left top;">
    <div id="container" class="menu" style="width: 300px">
        <!-- begin navigation -->
        <nav id="navigation" style="position: absolute;z-index: 100;margin-top: 10px;margin-left:10px;">
            <ul>
                <li><a href="/">Map</a></li>
                <li><a href="/chart">Chart</a></li>
            </ul>
        </nav>
        <!-- end navigation -->
    </div>
    <div class="btn btn-primary" type="button" style="position: absolute;z-index: 100;margin-top: 80px;margin-left:10px">
        GPS Count <span class="badge gps-count">0</span>
    </div>

    <div id="map" style="width:100%;height:700px"></div>

    <script type="text/javascript" src="/socket.io-client/socket.io.js"></script>
    <script type="text/javascript" src="/jquery/dist/jquery.min.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script>
        $(document).ready(function(){

            function mapInit(){
                var m,data = {};
                data.center = new google.maps.LatLng(40.1770,44.5148);
                data.zoom = 12;
                data.mapTypeId = google.maps.MapTypeId.ROADMAP;
                m = new google.maps.Map($('#map')[0],data);
                return m;
            }
            var map = mapInit();

            var socket = io();
            var markers = [];
            var markersCount = 0;

            //For polylines
            var polylines               = {};
            var bus_polylines           = {};
            var bus_section_part_marker = {};


            socket
                .on('connect', function (){
                    console.log('socket connected...')
                })
                .on('disconnect',function(){
                    console.log('socket disconnected...');
                })
                .on('message',function(msg){
                    var data = msg.data;
                    var section_part = msg.section_part;

                    console.log(data);

                    //If there are section part and corresponding section's polyline select it
                    if (section_part && polylines[section_part.section.id]) {

                        //Reselect last bus's polyline
                        if (bus_polylines[data.imei]) {
                            bus_polylines[data.imei].setOptions({strokeColor: '#FF0000'});
                        }

                        //Select corresponding polyline and save it in the bus_polylines object
                        polylines[section_part.section.id].setOptions({strokeColor: 'blue'});
                        bus_polylines[data.imei] = polylines[section_part.section.id];

                        //Create marker on the nearest section part center
                        pos = new google.maps.LatLng(section_part.latitude, section_part.longitude);
                        if (bus_section_part_marker[data.imei]){
                            bus_section_part_marker[data.imei].setPosition(pos)
                        }
                        else {
                            //Collect markers in the bus_section_part_marker object
                            bus_section_part_marker[data.imei] = new google.maps.Marker({
                                position: pos,
                                icon: "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png"
                            });

                            bus_section_part_marker[data.imei].setMap(map);
                        }
                    }

                    //Create bus marker to show bus place on the map
                    var pos = new google.maps.LatLng(data.latitude / 10000000, data.longitude / 10000000);
                    if(!markers[data.imei]) {
                        var marker = new google.maps.Marker({
                            position: pos
                        });
                        marker.setMap(map);
                        markers[data.imei] = marker;
                        markersCount++;
                    }
                    else {
                        markers[data.imei].setPosition(pos);
                    }

                    $(".gps-count").text(markersCount);
                });

            //Used to paint sections on the map
            $.getJSON('http://10.10.0.22/api/skeletons', function (sections) {
                var points = [];
                sections.forEach(function(section) {
                    points.push(new google.maps.LatLng(section.point1.latitude, section.point1.longitude));
                    points.push(new google.maps.LatLng(section.point2.latitude, section.point2.longitude));

                    //Collect each section in polylines object with section.id key
                    polylines[section.id] = new google.maps.Polyline({
                        path: points,
                        map: map,
                        geodesic: true,
                        strokeColor: '#FF0000',
                        strokeOpacity: 1.0,
                        strokeWeight: 2
                    });

                    points = [];

//                    This part is for drawing section part center markers
//                    $.getJSON('http://10.10.0.22/api/lines/' + section.id + '/section/parts', function (section_parts) {
//                        section_parts.forEach(function(section_part) {
//                            pos = new google.maps.LatLng(section_part.latitude, section_part.longitude);
//                            marker = new google.maps.Marker({
//                                position: pos,
//                                icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
//                            });
//                            marker.setMap(map);
//                        });
//                    });
                });
            });

            //Set marker in the station place
            var pos = new google.maps.LatLng(40.171613, 44.538151);
            var marker = new google.maps.Marker({
                position: pos,
                title:"Station",
                icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
            });
            marker.setMap(map);
        });
    </script>
</body>
</html>